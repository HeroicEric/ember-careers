var fs = require('fs');
var RSVP = require('rsvp');
var stat = RSVP.denodeify(fs.stat);
var readdir = RSVP.denodeify(fs.readdir);

function walk(baseDir, relativePath) {
  return stat(baseDir + '/' + relativePath)
        .then(function(stats) {
          if (stats.isDirectory()) {
            return readdir(baseDir + '/' + relativePath)
                   .then(function (entries) {
                      return RSVP.all(entries.map(function(entry) {
                        return walk(baseDir, relativePath + entry + '/')
                    }))
                    .then(function(entries) {
                      return Array.prototype.concat.apply([relativePath], entries)
                    });
            });
          } else {
            return [relativePath];
          }
        });
};

console.time('async')
walk('x' ,'').then(function (dirs) {
  console.timeEnd('async')
}, function (err) {
  console.error(err)
})

